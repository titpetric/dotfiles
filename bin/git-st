#!/bin/bash

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Find all .git directories, excluding vendor and node_modules
find . -type d -name .git \
  -not -path '*/vendor/*' \
  -not -path '*/node_modules/*' | while read git_dir; do
  
  repo_dir=$(dirname "$git_dir")
  
  # Get relative path for display
  display_path=${repo_dir#./}
  [ "$display_path" = "." ] && display_path="."
  
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  echo -e "${CYAN}Repository: ${BLUE}$display_path${NC}"
  echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
  
  cd "$repo_dir" || exit
  
  # Check for unpushed commits
  unpushed=$(git rev-list @{u}.. 2>/dev/null | wc -l)
  if [ "$unpushed" -gt 0 ]; then
    echo -e "${RED}⚠ Unpushed commits: $unpushed${NC}"
  fi
  
  # Get git status
  status=$(git status --porcelain)
  
  if [ -z "$status" ]; then
    echo -e "${GREEN}✓ Clean${NC}"
  else
    echo -e "${YELLOW}Modified/Untracked files:${NC}"
    echo "$status" | while IFS= read -r line; do
      status_code="${line:0:2}"
      filename="${line:3}"
      
      case "$status_code" in
        "M ") echo -e "  ${YELLOW}M${NC}  $filename" ;;  # Modified
        "A ") echo -e "  ${GREEN}A${NC}  $filename" ;;  # Added
        "D ") echo -e "  ${RED}D${NC}  $filename" ;;  # Deleted
        "??") echo -e "  ${RED}?${NC}  $filename" ;;  # Untracked
        *" M") echo -e "  ${YELLOW}${status_code}${NC} $filename" ;; # Staged modified
        *) echo -e "  ${YELLOW}${status_code}${NC} $filename" ;;
      esac
    done
  fi
  
  cd - > /dev/null
  echo ""
done
